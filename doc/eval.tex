This section presents an example using OTPO to optimize some of the
InfiniBand parameters of Open MPI on a given platform.  We therefore
first describe Open MPI's InfiniBand support and some of its run-time
tunable parameters, then present the results of the optimization using
OTPO.

\subsection{InfiniBand Parameters in Open MPI}

\input{motivation}

\subsection{Results}

Tests were run on the Shark cluster at the University of Houston.
Shark consists of 24 dual-core 2.2GHz AMD Opteron nodes connected by
4x InfiniBand and Gigabit Ethernet network interconnects.  
The InfiniBand switch is connected to two HCAs on every node, of which one is
active, with an {\tt active\_mtu} of 2048 and an {\tt active\_speed} of 2.5
Gbps. OFED 1.1 is installed on the nodes. 

A pre-release version of Open MPI v1.3 was used to generate these
results, Subversion trunk revision 17198. A nightly snapshot of the trunk was
used, and configured with debug disabled. All the tests were run with
{\tt MPI\_LEAVE\_PINNED} set to one.

OTPO was used to explore the parameter space of {\tt
  btl\_\-openib\_\-receive\_\-queues} to find a set of values that
yield the lowest short message latency.  Since {\tt receive\_\-queues}
is a multiple-value parameter, each sub-parameter must be described to
OTPO.  The individual sub-parameters become ``virtual'' parameters,
each with a designated range to explore.  OTPO was configured to test
both a per-peer and a shared receive queue with the ranges listed in
Table~\ref{table:eval-queue-search-params}.  Each sub-parameter
spanned its range by doubling its value from the minimum to the
maximum (e.g., 1, 2, 4, 8, 16, ...).

\def\yes{$\sqrt{}$}

\begin{table}[tb]
\centering
\caption{InfiniBand receive queue search parameter ranges.The ``max
  pending sends'' sub-parameter is only relevant for shared receive
  queues.}
\label{table:eval-queue-search-params} 
\begin{tabular}{|l|c|c|c|} 
\multicolumn{1}{c}{Sub-parameter} &
\multicolumn{1}{c}{Range} &
\multicolumn{1}{c}{Per-peer} &
\multicolumn{1}{c}{Shared} \\
\hline
Buffer size (bytes) & 65,536 $\rightarrow$ 1,048,576 & \yes & \yes \\
Number of buffers & 1 $\rightarrow$ 1024 & \yes & \yes \\
Low watermark (buffers) & 32 $\rightarrow$ 512  & \yes & \yes \\
Max pending sends & 1 $\rightarrow$ 32 & & \yes \\
\hline
\end{tabular}
\end{table}

The parameters that are used are explained as follows:\\
\begin{itemize}
\item The size of the receive buffers to be posted.
\item The maximum number of buffers posted for incoming message fragments.
\item the number of available buffers left on the queue before Open
  MPI reposts buffers up to the maximum (previous parameter).
\item the maximum number of outstanding sends that are allowed at a
  given time (SRQ only).
\end{itemize}

The parameter space from Table~\ref{table:eval-queue-search-params} yields,
275 for per-peer queue and 825 for shared queue, valid combinations (after
removing unnecessary combinations that would cause to incorrect
results). These combinations stressed buffer management and flow control
issues in the Open MPI short message protocol when sending 1 byte
messages. Using the brute force method, OTPO took, 3 minutes for the first
case and 9 minutes for the second case, to invoke NetPIPE for each of these
parameter combinations.  Note that NetPIPE runs several ping-pong tests and
reports half the average round-trip time.  OTPO sought parameter sets that
minimized this value.

\begin{table}[tb]
\centering
\caption{OTPO results of the best parameter combinations (PPQ).}
\label{table:results-ppq} 
\begin{tabular}{|c|c|} \hline
Latency & Number of Combinations \\
\hline
3.78$\mu s$  & 3\\
\hline
3.79$\mu s$  & 3\\
\hline
3.80$\mu s$  & 15\\
\hline
3.81$\mu s$  & 21\\
\hline
3.82$\mu s$  & 31\\
\hline
3.83$\mu s$  & 34\\
\hline
\end{tabular}  
\end{table}

\begin{table}[tb]
\centering
\caption{OTPO results of the best parameter combinations (SRQ).}
\label{table:results-srq} 
\begin{tabular}{|c|c|} \hline
Latency & Number of Combinations \\
\hline
3.77$\mu s$  & 1\\
\hline
3.78$\mu s$  & 4\\
\hline
3.79$\mu s$  & 18\\
\hline
3.80$\mu s$  & 32\\
\hline
3.81$\mu s$  & 69\\
\hline
3.82$\mu s$  & 69\\
\hline
\end{tabular}  
\end{table}

The results are summarized in Table~\ref{table:results-ppq} and
Table~\ref{table:results-srq}. Although there were few parameter sets that
resulted in the lowest latency ($3.78\mu s$ and $3.77\mu s$), there were many
others that were within $0.05\mu s$.  With timings this low, jitter within the
results is to be expected.

%%% Local Variables: 
%%% mode: latex
%%% TeX-master: "paper"
%%% End: 
